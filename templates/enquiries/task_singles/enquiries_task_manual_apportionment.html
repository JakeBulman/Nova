{% extends 'nova_core/base.html' %}

{% block content %}

<style type="text/css">
    .container-fluid.custom-container {
      padding: 0 50px;
    }
</style>

<h1 class="display-5 mb-4 mt-3 mx-5 text-center">EAR Task - Manual Apportionment</h1>

<div class="container-fluid">
    <div class="row text-center">
        <div class="row text-center">
            <div class="col mb-5 mx-5">
                <a class="btn btn-primary btn-lg" style="width: 500px" href='/enquiries/task_manager/my_tasks'>&lt;&lt; Back to My Tasks</a>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col text-center text-dark ms-5 me-3 bg-light rounded">
            <div class="row text-center m-3">
                <h5>Task Summary</h5>
                <table class="table table-sm table-bordered table-hover text-center bg-light">
                    <tr class="text-center">
                        <th class="text-dark">Task ID</th>
                        <td>{{ task.id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Enquiry ID</th>
                        <td>{{ task.enquiry_id.enquiry_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Script ID</th>
                        <td>{{ task.ec_sid.ec_sid }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Service Code</th>
                        <td>{{ task.ec_sid.erp_sid.service_code }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Centre ID</th>
                        <td>{{ task.ec_sid.erp_sid.eps_centre_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Syllabus/Component</th>
                        <td>{{ task.ec_sid.eps_ass_code }}/{{ task.ec_sid.eps_com_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Session Name</th>
                        <td>{{ task.ec_sid.eps_ses_name }}</td>
                    </tr>
                    <tr class="text-center">
                        <th class="text-dark">Script Type</th>
                        <td>{{ task.ec_sid.script_type }}</td>
                    </tr>
                </table>
            </div>
            <div class="row text-center my-5">
                <h5>Task Instruction</h5>
                <div>Please apportion to an available examiner (01.01 in the first instance) with no COI and ensure they are not the previous examiner. Please raise with TL if you have any issues.</div>
            </div>

            {% if issue_reason %}<h2 class="text-center text-primary mb-3">ISSUE REASON: {{issue_reason}}</h2>{% endif %}
        </div>


        <div class="col text-center ms-3 me-5 bg-light text-dark rounded">
            <div class="row text-center m-3">
                <h5>Task Comments</h5>
                <table class="table table-bordered table-hover text-center bg-white">
                    <tr class="text-center">
                        <th class="text-dark">Comment</th>
                        <th class="text-dark">Creation Date</th>
                        <th class="text-dark">Creator</th>
                        <th class="text-dark">Task Complete</th>
                    </tr>
                    {% for comment in task_comments %}
                    {% if comment.task_comment_invalid == 0 %}
                    <tr class="text-center">
                        <td style="word-break: break-word;">{{ comment.task_comment_text }}</td>
                        <td>{{ comment.task_comment_creation_date|date:"d/m/y H:i" }}</td>
                        <td>{{ comment.task_comment_user }}</td>
                        <td>                        
                            <form method="POST" action="{% url 'remove_task_comment' %}" class="form-inline">
                                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                    <input name="comment_id" id="comment_id" value={{comment.id}} type="hidden" class="form-control">
                                    <button type="submit" class="btn btn-danger btn-sm" style="width:100px" onClick="this.form.submit(); this.disabled=true;">Remove</button>
                            </form>  
                        </td>
                    </tr>
                    {% else %}
                    <tr class="text-center">
                        <td class="text-info" style="word-break: break-word;">{{ comment.task_comment_text }}</td>
                        <td class="text-info">{{ comment.task_comment_creation_date|date:"d/m/y H:i" }}</td>
                        <td class="text-info">{{ comment.task_comment_user }}</td>
                        <td>                        
                            <form method="POST" action="{% url 'remove_task_comment' %}" class="form-inline">
                                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                    <input name="comment_id" id="comment_id" value={{comment.id}} type="hidden" class="form-control">
                                    <button disabled type="submit" class="btn btn-info btn-sm" style="width:100px">Remove</button>
                            </form>  
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    <tr class="text-center">
                        <td colspan="4">
                        <form method="POST" action="{% url 'add_task_comment' %}" class="form-inline">
                            <table class="table table-sm text-center bg-white">
                                <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                <td><input name="task_comment" id="task_comment" type="text" class="form-control"></td>
                                <td><button type="submit" class="btn btn-primary" style="width:200px" onClick="this.form.submit(); this.disabled=true;">Add Comment</button></td>
                            </table>
                        </form>   
                        </td>                  
                    </tr>
                    
                </table>
            </div>
            <div class="row text-center m-3">
                <h5>Panel Notes</h5>
                <div>{{panel_notes}}</div>
            </div>

        </div>
    </div>
    <div class="row text-center">
        <div class="col text-center my-4 mx-5 bg-light text-dark rounded">
            <div class="row text-center m-3">
                <h5>Available Examiner List</h5>
                <table class="table table-sm table-bordered table-hover text-center bg-white">
                    <tr class="text-center">
                        <th class="text-dark">Creditor Number</th>
                        <th class="text-dark">Examiner Name</th>
                        <th class="text-dark">Examiner Email</th>
        
                        
                        <th class="text-dark">Examiner Position</th>
                        <th class="text-dark">Panel Size</th>  
                        <th class="text-dark">Previous Examiner</th>
                                
                        
                        <th class="text-dark">Conflict of Interest List</th>
                        <th class="text-dark">Examiner Notes</th>
                        <th class="text-dark">Examiner Unavailability</th>
                        <th class="text-dark">Assigned Scripts</th>  
                        <th class="text-dark">Select Examiner</th>
                    </tr>
                    {% for exm in ep %}
                        {% for exm2 in exm.creditors.all %}
                        {% for exm3 in exm2.exm_per_details.all %}
                        {% if exm3.ass_code == task.ec_sid.eps_ass_code and exm3.com_id == task.ec_sid.eps_com_id and exm2.currently_valid == True %}
                            <tr>
                                <td class="text-center"><a class="btn btn-outline-primary" style="width:100px" href='/enquiries/examiner_detail/{{ exm.per_sid }}'>{{ exm.exm_creditor_no }}</a></td>
                                <td>{{ exm.exm_title }} {{ exm.exm_initials }} ({{ exm.exm_forename }}) {{ exm.exm_surname }}</td>
                                {% if exm.exm_email_manual.all.count > 0 %}
                                    <td>{% for emails in exm.exm_email_manual.all %}{{ emails.examiner_email_manual|upper }}{% endfor %}</td>
                                {% else %}
                                    <td>{{ exm.exm_email }}</td>
                                {% endif %}
                                <td>
                                    <table class="table table-sm text-center">

                                            <tr>
                                                <td>{{ exm3.exm_examiner_no }} - </td>
                                            </tr>
            
                                    </table>
                                </td>
                                <td>
                                    <table class="table table-sm text-center">

                                            <tr>
                                                <td>{{ exm3.panel_size }}</td>
                                            </tr>

                                    </table>
                                </td>
                                    <td style="word-break: break-word; font-weight: bold; color: red;">
                                        {% for appor in task.ec_sid.script_prev_exm.all %}
                                            {% if appor.exm_position == exm3.exm_examiner_no %}
                                                -X-
                                            {% endif %}   
                                        {% endfor %}
                                    </td>
                                <td>
                                    <table class="table table-sm text-center">
                                        {% for conf in exm.exm_conflicts.all %}
                                            {% if task.ec_sid.erp_sid.eps_centre_id in conf.examiner_conflicts %}
                                                <tr>
                                                    <td style="word-break: break-word; font-weight: bold; color: red;">{{ conf.examiner_conflicts }}</td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <td style="word-break: break-word;">{{ conf.examiner_conflicts }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %} 
                                    </table>
                                </td>
                                <td>
                                    <table class="table table-sm text-center">
                                        {% for noted in exm.exm_notes.all %}
                                            <tr>
                                                <td style="word-break: break-word;">{{ noted.examiner_notes }}</td>
                                            </tr>
                                        {% endfor %} 
                                    </table>
                                </td>
                                <td>
                                    <table class="table table-sm text-center">
                                        {% for avail in exm.exm_availability.all %}
                                            {% now "d/m/y" as todays_date %}
                                            {% if todays_date >= avail.unavailability_start_date|date:"d/m/y" and todays_date < avail.unavailability_end_date|date:"d/m/y" %}
                                                <tr>
                                                    <td style="word-break: break-word; font-weight: bold; color: red;">{{ avail.unavailability_start_date|date:"d/m/y" }}-{{ avail.unavailability_end_date|date:"d/m/y" }}</td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <td style="word-break: break-word;">{{ avail.unavailability_start_date|date:"d/m/y" }}-{{ avail.unavailability_end_date|date:"d/m/y" }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </table>
                                </td>
                                <td>
                                    <table class="table table-sm text-center">

                                            <tr>
                                                <td>
                                                    {{ exm.script_count }}
                                                </td>
                                            </tr>
            
                                    </table>
                                </td>
                                <td><form method="POST" action="{% url 'manual-apportionment-complete' %}" class="text-center">
                                    <input name="enpe_sid" id="enpe_sid" value={{exm3.enpe_sid.enpe_sid}} type="hidden" class="form-control">                                    
                                    <input name="script_id" id="script_id" value={{task.ec_sid.ec_sid}} type="hidden" class="form-control">
                                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                    <input name="enquiry_id" id="enquiry_id" value={{task.enquiry_id.enquiry_id}} type="hidden" class="form-control">
                                    <button type="submit" class="btn btn-warning text-white" style="width:120px" onClick="this.form.submit(); this.disabled=true;">Apportion</button>
                                </form></td>  
                            </tr>
                            {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>

</div>



{% endblock %}