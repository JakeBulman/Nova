{% extends 'nova_core/base.html' %}

{% block content %}

<h1 class="display-5 mb-4 mt-3 mx-5 text-center">EAR Task - MIS vs RM</h1>

<div class="container-fluid">
    <div class="row text-center">
        <div class="row text-center">
            <div class="col mb-5 mx-5">
                <a class="btn btn-primary btn-lg" style="width: 500px" href='/enquiries/task_manager/my_tasks'>&lt;&lt; Back to My Tasks</a>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col text-center text-dark ms-5 me-3 bg-light rounded">
            <div class="row text-center m-3">
                <h5>Task Summary</h5>
                <table class="table table-sm table-bordered table-hover text-center">
                    <tr class="text-center">
                        <th>Task ID</th>
                        <td>{{ task.id }}</td>
                        <th>Centre Number</th>
                        <td>{{ task.ec_sid.erp_sid.eps_centre_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Enquiry ID</th>
                        <td><a href='/enquiries/enquiries_detail/{{ task.enquiry_id.enquiry_id }}'>{{ task.enquiry_id.enquiry_id }}</a></td>
                        <th>Candidate Number</th>
                        <td>{{ task.ec_sid.erp_sid.eps_cand_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Script ID</th>
                        <td>{{ task.ec_sid.ec_sid }}</td>
                        <th>Syllabus</th>
                        <td>{{ task.ec_sid.eps_ass_code }}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Batch ID</th>
                        <td>{% for bat in task.ec_sid.script_id.all %}{{ bat.eb_sid.eb_sid }}{% endfor %}</td>
                        <th>Component</th>
                        <td>{{ task.ec_sid.eps_com_id }}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Original Examiner</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.original_exm }}{% endfor %}</td>
                        <th>Original Mark</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.original_mark }}{% endfor %}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Remark Examiner</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.rev_exm }}{% endfor %}</td>
                        <th>Remark Examiner Name</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}
                            {% for exm in mis.ec_sid.apportion_script.all %}
                            {% if exm.apportionment_invalidated == 0 %}
                            {{ exm.enpe_sid.per_sid.exm_title }} {{ exm.enpe_sid.per_sid.exm_initials }} ({{ exm.enpe_sid.per_sid.exm_forename }}) {{ exm.enpe_sid.per_sid.exm_surname }}
                            {% endif %}
                            {% endfor %}
                            {% endfor %}</td>
                    </tr>
                    <tr class="text-center">
                        <th colspan="2">Remark Examiner Email</th>
                        <td colspan="2">{% for mis in task.ec_sid.script_mis.all %}
                            {% for exm in mis.ec_sid.apportion_script.all %}
                            {% if exm.apportionment_invalidated == 0 %}
                            {{ exm.enpe_sid.per_sid.exm_email }}
                            {% endif %}
                            {% endfor %}
                            {% endfor %}</td>
                    </tr>
                </table>
                <table class="table table-sm table-bordered table-hover text-center">
                    <tr class="text-center">
                        <th>Revised Mark</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.revised_mark }}{% endfor %}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Mark Status</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.mark_status }}{% endfor %}</td>
                    </tr>
                    <tr class="text-center">
                        <th>Justification Code</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.justification_code }}{% endfor %}</td>             
                    </tr>
                </table>
                <table class="table table-sm table-bordered table-hover text-center">
                    <tr class="text-center">
                        <th>JC4 Remark Reason</th>
                        <td>{% for mis in task.ec_sid.script_mis.all %}{{ mis.remark_reason }}{% endfor %}</td>             
                    </tr>
                </table>
                {% if task.ec_sid.script_type == "RM Assessor" %}
                <table class="table table-primary table-sm table-bordered table-hover text-center">
                    <tr class="text-center">
                        <th class="text-dark">Script Type</th>
                        <td>{{ task.ec_sid.script_type }}</td>            
                    </tr>
                </table>
                {% else %}
                <table class="table table-danger table-sm table-bordered table-hover text-center">
                    <tr class="text-center">
                        <th class="text-dark">Script Type</th>
                        <td>{{ task.ec_sid.script_type }}</td>            
                    </tr>
                </table>
                {% endif %}


                <h5>Task Instruction</h5>
                <div>1 - Please check the script has been submitted correctly </div>
                <div>2 - Please check the mark awarded matches the mark returned and if changed, a justification code is given.</div>
                <div>3 - Please check for annotations on the script. </div>
            </div>

            {% if issue_reason %}<h2 class="text-center text-primary">ISSUE REASON: {{issue_reason}}</h2>{% endif %}
        </div>
        
        <div class="col text-center ms-3 me-5 bg-light text-dark rounded">
            <div class="row text-center m-3">
                <h5>Task Comments</h5>
                <table class="table table-bordered table-hover text-center bg-white">
                    <tr class="text-center">
                        <th class="text-dark">Comment</th>
                        <th class="text-dark">Creation Date</th>
                        <th class="text-dark">Creator</th>
                        <th class="text-dark">Task Complete</th>
                    </tr>
                    {% for comment in task_comments %}
                    {% if comment.task_comment_invalid == 0 %}
                    <tr class="text-center">
                        <td style="word-break: break-word;">{{ comment.task_comment_text }}</td>
                        <td>{{ comment.task_comment_creation_date|date:"d/m/y H:i" }}</td>
                        <td>{{ comment.task_comment_user }}</td>
                        <td>                        
                            <form method="POST" action="{% url 'remove_task_comment' %}" class="form-inline">
                                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                    <input name="comment_id" id="comment_id" value={{comment.id}} type="hidden" class="form-control">
                                    <button type="submit" class="btn btn-danger btn-sm" style="width:100px" onClick="this.form.submit(); this.disabled=true;">Remove</button>
                            </form>  
                        </td>
                    </tr>
                    {% else %}
                    <tr class="text-center">
                        <td class="text-info" style="word-break: break-word;">{{ comment.task_comment_text }}</td>
                        <td class="text-info">{{ comment.task_comment_creation_date|date:"d/m/y H:i" }}</td>
                        <td class="text-info">{{ comment.task_comment_user }}</td>
                        <td>                        
                            <form method="POST" action="{% url 'remove_task_comment' %}" class="form-inline">
                                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                    <input name="comment_id" id="comment_id" value={{comment.id}} type="hidden" class="form-control">
                                    <button disabled type="submit" class="btn btn-info btn-sm" style="width:100px">Remove</button>
                            </form>  
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    <tr class="text-center">
                        <td colspan="4">
                        <form method="POST" action="{% url 'add_task_comment' %}" class="form-inline">
                            <table class="table table-sm text-center bg-white">
                                <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                                <td><input name="task_comment" id="task_comment" type="text" class="form-control"></td>
                                <td><button type="submit" class="btn btn-primary" style="width:200px" onClick="this.form.submit(); this.disabled=true;">Add Comment</button></td>
                            </table>
                        </form>   
                        </td>                  
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="row text-center">
        <div class="col text-center mt-4 ms-5 me-3 bg-light text-dark rounded">
            <div class="row text-center m-3">
                <h5>Confirm MIS</h5>
                    <form method="POST" action="{% url 'misvrm-complete' %}" class="text-center">
                    <input name="script_id" id="script_id" value={{task.ec_sid.ec_sid}} type="hidden" class="form-control">
                    <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                    <input name="enquiry_id" id="enquiry_id" value={{task.enquiry_id.enquiry_id}} type="hidden" class="form-control">
                    <div class="row">
                        <label class="form-label mb-5">If the values above are correct, please confirm the MIS.</label>
                    </div>
                    <div class="row">
                        <div class="col align-self-center">
                            <button type="submit" class="btn btn-success btn-lg my-2" style="width:300px">Confirm Current MIS</button>
                        </div>
                    </div>
                    </form>
            </div> 
        </div> 


        <div class="col text-center mt-4 ms-3 me-5 bg-light text-dark rounded">
            <div class="row text-center m-3">
                <h5>Update MIS</h5>
            <div class="col align-self-center">
                <form method="POST" action="{% url 'misvrm-complete' %}" class="text-center">
                <input name="script_id" id="script_id" value={{task.ec_sid.ec_sid}} type="hidden" class="form-control">
                <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                <input name="enquiry_id" id="enquiry_id" value={{task.enquiry_id.enquiry_id}} type="hidden" class="form-control">
                <label class="form-label">If different, enter a new Mark, Justification Code and Status below. This should be confirmed with the examiner before continuing.</label>
                <label class="form-label mb-5">You MUST enter all relevant fields, blanks fields will override any values.</label>

                <div class="row">
                    <div class="col">
                        <label class="form-label text-end">New Mark</label>
                    </div>
                    <div class="col">
                        <input name="new_mark" id="new_mark" type="number" min="0" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" class="form-control text-center" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label class="form-label">New Justification Code</label>
                    </div>
                    <div class="col">
                        <input name="new_jc" id="new_jc" type="text" class="form-control text-center" required> 
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label class="form-label">New Status</label>
                    </div>
                    <div class="col">
                        <select name="new_status" id="new_status" type="number" class="form-select text-center" required>
                            <option selected></option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Changed">Changed</option>
                        </select>   
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label class="form-label">New JC4 Reasoning</label>
                    </div>
                    <div class="col">
                        <input name="new_jc4r" id="new_jc4r" type="text" class="form-control text-center" required> 
                    </div>
                </div>
                
                



                    <button type="submit" class="btn btn-danger btn-lg my-4" style="width:300px">Update MIS</button>
                </form>
            </div>
            </div>  
        </div> 
    </div>
</div>


{% endblock %}