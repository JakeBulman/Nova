{% extends 'base.html' %}

{% block content %}

<h1 class="display-5 text-center mb-5">EAR Task - Manual Apportionment</h1>


<div class="container">
    <div class="row text-center">
        <a class="btn btn-secondary btn-lg my-2" href='/enquiries/task_manager/my_tasks'>Back to My Tasks</a>
    </div>

        <div class="row text-center my-3">
            <h5>Task Summary</h5>
            <table class="table table-sm table-bordered table-hover text-center">
                <tr class="text-center">
                    <th>Task ID</th>
                    <td>{{ task.id }}</td>
                </tr>
                <tr class="text-center">
                    <th>Enquiry ID</th>
                    <td>{{ task.enquiry_id.enquiry_id }}</td>
                </tr>
                <tr class="text-center">
                    <th>Script ID</th>
                    <td>{{ task.ec_sid.ec_sid }}</td>
                </tr>
                <tr class="text-center">
                    <th>Service Code</th>
                    <td>{{ task.ec_sid.erp_sid.service_code }}</td>
                </tr>
                <tr class="text-center">
                    <th>Centre ID</th>
                    <td>{{ task.ec_sid.erp_sid.eps_centre_id }}</td>
                </tr>
                <tr class="text-center">
                    <th>Syllabus/Component</th>
                    <td>{{ task.ec_sid.eps_ass_code }}/{{ task.ec_sid.eps_com_id }}</td>
                </tr>
                <tr class="text-center">
                    <th>Session Name</th>
                    <td>{{ task.ec_sid.eps_ses_name }}</td>
                </tr>
            </table>
        </div>

        {% if issue_reason %}<h2 class="text-center text-primary mb-3">ISSUE REASON: {{issue_reason}}</h2>{% endif %}

        <div class="row text-center">
            <h5>Available Examiner List</h5>
            <table class="table table-sm table-bordered table-hover">
                <tr class="text-center">
                    <th>Creditor Number</th>
                    <th>Examiner Name</th>
                    <th>Examiner Email</th>
    
                    
                    <th>Examiner Position</th>
                    <th>Panel Size</th>  
                    <th>Previous Examiner</th>
                            
                    
                    <th>Conflict of Interest List</th>
                    <th>Examiner Notes</th>
                    <th>Examiner Unavailability</th>
                    <th>Assigned Scripts</th>  
                    <th>Select Examiner</th>
                </tr>
                {% for exm in ep %}
                    
                    <tr>
                        <td class="text-center"><a class="btn btn-outline-primary" style="width:100px" href='/enquiries/examiner_detail/{{ exm.per_sid }}'>{{ exm.exm_creditor_no }}</a></td>
                        <td>{{ exm.exm_title }} {{ exm.exm_initials }} ({{ exm.exm_forename }}) {{ exm.exm_surname }}</td>
                        {% if exm.exm_email_manual.all.count > 0 %}
                            <td>{% for emails in exm.exm_email_manual.all %}{{ emails.examiner_email_manual|upper }}{% endfor %}</td>
                        {% else %}
                            <td>{{ exm.exm_email }}</td>
                        {% endif %}

                        {% for exm2 in exm.creditors.all %}
                        {% for exm3 in exm2.exm_per_details.all %}
                        {% if exm3.ass_code == task.ec_sid.eps_ass_code and exm3.com_id == task.ec_sid.eps_com_id %}
                        
                        <td>
                            <table class="table table-sm text-center">

                                    <tr>
                                        <td>{{ exm3.exm_examiner_no }}</td>
                                    </tr>
    
                            </table>
                        </td>
                        <td>
                            <table class="table table-sm text-center">

                                    <tr>
                                        <td>{{ exm3.panel_size }}</td>
                                    </tr>

                            </table>
                        </td>

                                        <td style="word-break: break-word; font-weight: bold; color: red;">
                                            {% for appor in task.ec_sid.script_prev_exm.all %}
                                                {% if appor.exm_position == exm3.exm_examiner_no %}
                                                    -X-
                                                {% endif %}   
                                            {% endfor %}
                                        </td>


                        <td>
                            <table class="table table-sm text-center">
                                {% for conf in exm.enpe_sid.per_sid.exm_conflicts.all %}
                                    {% if task.ec_sid.erp_sid.eps_centre_id in conf.examiner_conflicts %}
                                        <tr>
                                            <td style="word-break: break-word; font-weight: bold; color: red;">{{ conf.examiner_conflicts }}</td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td style="word-break: break-word;">{{ conf.examiner_conflicts }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %} 
                            </table>
                        </td>

                        <td>
                            <table class="table table-sm text-center">
                                {% for noted in exm.enpe_sid.per_sid.exm_notes.all %}
                                    <tr>
                                        <td style="word-break: break-word;">{{ noted.examiner_notes }}</td>
                                    </tr>
                                {% endfor %} 
                            </table>
                        </td>
                        
                        <td>
                            <table class="table table-sm text-center">
                                {% for avail in exm.enpe_sid.per_sid.exm_availability.all %}
                                    {% now "d/m/y" as todays_date %}
                                    {% if todays_date >= avail.unavailability_start_date|date:"d/m/y" and todays_date < avail.unavailability_end_date|date:"d/m/y" %}
                                        <tr>
                                            <td style="word-break: break-word; font-weight: bold; color: red;">{{ avail.unavailability_start_date|date:"d/m/y" }}-{{ avail.unavailability_end_date|date:"d/m/y" }}</td>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td style="word-break: break-word;">{{ avail.unavailability_start_date|date:"d/m/y" }}-{{ avail.unavailability_end_date|date:"d/m/y" }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </table>
                        </td>

                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                        <td>
                            <table class="table table-sm text-center">

                                    <tr>
                                        <td>
                                            {{ exm.script_count }}
                                        </td>
                                    </tr>
    
                            </table>
                        </td>
                        <td><form method="POST" action="{% url 'manual-apportionment-complete' %}" class="text-center">
                            {% for exm2 in exm.creditors.all %}
                            {% for exm3 in exm2.exm_per_details.all %}
                            {% if exm3.ass_code == task.ec_sid.eps_ass_code and exm3.com_id == task.ec_sid.eps_com_id %}
                            <input name="enpe_sid" id="enpe_sid" value={{exm3.enpe_sid.enpe_sid}} type="hidden" class="form-control">
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                            <input name="script_id" id="script_id" value={{task.ec_sid.ec_sid}} type="hidden" class="form-control">
                            <input name="task_id" id="task_id" value={{task.id}} type="hidden" class="form-control">
                            <input name="enquiry_id" id="enquiry_id" value={{task.enquiry_id.enquiry_id}} type="hidden" class="form-control">
                            <button type="submit" class="btn btn-primary" style="width:120px">Apportion</button>
                        </form></td>  
                    </tr>
                {% endfor %}
            </table>
        </div>

</div>



{% endblock %}