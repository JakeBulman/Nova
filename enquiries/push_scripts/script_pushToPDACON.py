from openpyxl import load_workbook
import sys
import os
import django
from django.utils import timezone

if os.getenv('DJANGO_DEVELOPMENT') == 'true':
    print('DEV')
    path = os.path.join('C:\\Users\\bulmaj\\OneDrive - Cambridge\\Desktop\\Dev\\Nova')
    sys.path.append(path)
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings_dev'
elif os.getenv('DJANGO_PRODUCTION') == 'true':
    print('PROD')
    path = os.path.join('C:\\Dev\\Nova')
    sys.path.append(path)
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings_prod'
else:
    print('UAT')
    sys.path.append('C:/Dev/redepplan')
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings'

django.setup()

from enquiries.models import TaskManager, RpaFailureAudit, ScriptApportionment, EnquiryComponentElements, CentreEnquiryRequests, EnquiryComponents, EnquiryComponentsHistory, TaskTypes, ScaledMarks,GradeFailureAudit
from django.contrib.auth.models import User

ec_list = ['1307104',
'1307160',
'1308066',
'1308390',
'1308176',
'1315258',
'1315076',
'1315666',
'1315366',
'1308916',
'1315574',
'1311806',
'1308948',
'1315620',
'1305896',
'1305912',
'1306070',
'1306102',
'1305332',
'1305362',
'1305394',
'1305468',
'1305522',
'1305624',
'1305644',
'1305818',
'1305872',
'1305882',
'1305888',
'1302722',
'1302750',
'1303070',
'1303092',
'1303352',
'1303556',
'1303578',
'1303620',
'1303744',
'1303806',
'1303870',
'1303896',
'1303908',
'1303988',
'1304078',
'1304120',
'1304508',
'1304600',
'1304616',
'1304630',
'1304700',
'1304774',
'1304876',
'1304880',
'1304890',
'1304892',
'1304958',
'1305016',
'1305028',
'1305172',
'1305202',
'1305234',
'1305236',
'1305242',
'1306112',
'1306200',
'1306274',
'1306282',
'1306490',
'1306500',
'1306600',
'1306660',
'1306678',
'1306724',
'1306792',
'1306860',
'1307010',
'1307026',
'1307126',
'1307134',
'1307158',
'1307166',
'1307200',
'1307204',
'1307314',
'1307318',
'1307362',
'1307402',
'1307424',
'1307812',
'1307882',
'1307966',
'1308044',
'1308078',
'1308100',
'1308224',
'1308240',
'1308268',
'1308302',
'1308338',
'1308344',
'1308370',
'1308394',
'1308464',
'1308620',
'1308654',
'1308908',
'1308998',
'1309034',
'1309038',
'1309054',
'1309088',
'1309112',
'1309198',
'1309244',
'1309248',
'1309250',
'1309408',
'1309416',
'1309432',
'1309468',
'1309504',
'1309522',
'1309526',
'1309624',
'1309710',
'1309790',
'1309826',
'1309832',
'1309910',
'1309914',
'1309980',
'1310078',
'1310100',
'1310150',
'1310156',
'1310162',
'1310188',
'1310198',
'1310232',
'1310236',
'1310246',
'1310280',
'1310306',
'1310360',
'1310426',
'1310460',
'1310496',
'1310500',
'1310568',
'1310592',
'1310648',
'1310706',
'1310766',
'1310848',
'1310868',
'1311030',
'1311034',
'1311044',
'1311054',
'1311064',
'1311166',
'1311236',
'1311242',
'1311254',
'1311264',
'1311282',
'1311288',
'1311332',
'1311374',
'1311452',
'1311518',
'1311574',
'1311630',
'1311634',
'1311782',
'1311786',
'1311902',
'1311946',
'1311948',
'1312068',
'1312164',
'1312286',
'1312294',
'1312448',
'1312462',
'1312464',
'1312492',
'1312518',
'1312528',
'1312566',
'1312576',
'1312660',
'1312664',
'1312726',
'1312798',
'1312812',
'1312848',
'1312868',
'1312876',
'1312880',
'1312892',
'1313076',
'1313104',
'1313140',
'1313202',
'1313240',
'1313260',
'1313266',
'1313300',
'1313318',
'1313324',
'1313334',
'1313348',
'1313356',
'1313398',
'1313432',
'1313458',
'1313482',
'1313522',
'1313616',
'1313678',
'1313702',
'1313718',
'1313732',
'1314054',
'1314064',
'1314068',
'1314106',
'1314144',
'1314146',
'1314150',
'1314260',
'1314268',
'1314276',
'1314448',
'1314524',
'1314594',
'1314638',
'1314680',
'1314686',
'1314692',
'1314694',
'1314708',
'1314752',
'1314776',
'1314794',
'1314796',
'1314826',
'1314828',
'1314852',
'1314918',
'1313052',
'1313210',
'1313664',
'1314048',
'1310358',
'1310374',
'1310450',
'1310492',
'1310838',
'1310902',
'1315230',
'1315656',
'1315372',
'1305508',
'1305684',
'1305780',
'1303102',
'1303118',
'1303126',
'1304560',
'1304950',
'1305112',
'1305278',
'1306470',
'1306744',
'1306812',
'1306826',
'1306830',
'1307398',
'1307616',
'1307908',
'1308018',
'1308128',
'1308276',
'1308760',
'1309002',
'1309084',
'1309242',
'1309300',
'1309648',
'1309674',
'1309758',
'1309862',
'1311134',
'1311246',
'1311532',
'1311550',
'1311624',
'1311960',
'1312000',
'1312170',
'1312494',
'1312496',
'1312754',
'1312914',
'1312922',
'1312978',
'1315278',
'1315362',
'1315050',
'1315598',
'1306596',
'1308002',
'1308202',
'1309698',
'1310382',
'1310410',
'1310862',
'1311322',
'1312242',
'1312244',
'1312248',
'1313204',
'1313524',
'1314790',
'1309398',
'1306714',
'1310898',
'1308790',
'1302504',
'1309238',
'1311702',
'1311760',
'1312018',
'1312272',
'1312456',
'1312596',
'1312826',
'1312888',
'1313176',
'1313186',
'1313368',
'1314026',
'1314108',
'1310244',
'1311052',
'1315318',
'1315028',
'1315470',
'1315582',
'1314194',
'1314358',
'1314560',
'1314804',
'1315056',
'1315034',
'1315568',
'1310120',
'1307918',
'1307576',
'1308800',
'1308986',
'1309078',
'1309130',
'1309276',
'1314656',
'1314152',
'1307052',
'1309682',
'1310824',
'1310976',
'1309668',
'1308298',
'1305088',
'1303802',
'1305096',
'1305560',
'1304150',
'1306648',
'1313438',
'1305292',
'1304812',
'1310046',
'1306722',
'1309076',
'1309122',
'1311854',
'1314098',
'1311502',
'1304160',
'1303100',
'1307878',

]

def run_algo():
    for app_task in TaskManager.objects.filter(task_id='PDACON', enquiry_id__in = ec_list):
        task_id = app_task.pk
        enquiry_id = TaskManager.objects.get(pk=task_id).enquiry_id.enquiry_id
        if not TaskManager.objects.filter(enquiry_id=enquiry_id, task_id='GRDCHG',task_completion_date = None).exists():
            TaskManager.objects.create(
                enquiry_id = CentreEnquiryRequests.objects.get(enquiry_id=enquiry_id),
                ec_sid = None,
                task_id = TaskTypes.objects.get(task_id = 'GRDCHG'),
                task_assigned_to = None,
                task_assigned_date = None,
                task_completion_date = None
            )

        # if not TaskManager.objects.filter(enquiry_id=enquiry_id, task_id='GRDREJ',task_completion_date = None).exists():
        #     new_task = TaskManager.objects.create(
        #         enquiry_id = CentreEnquiryRequests.objects.get(enquiry_id=enquiry_id),
        #         ec_sid = None,
        #         task_id = TaskTypes.objects.get(task_id = 'GRDREJ'),
        #         task_assigned_to = None,
        #         task_assigned_date = None,
        #         task_completion_date = None
        #     )
        #     GradeFailureAudit.objects.create(
		# 		task_key = TaskManager.objects.get(pk=new_task.pk),
		# 		failure_stage = TaskTypes.objects.get(task_id='PEACON'),
		# 		failure_reason = 'Numeric Grade Change' 
        #     )		

        #complete the task
        TaskManager.objects.filter(pk=task_id,task_id='PDACON').update(task_completion_date=timezone.now())    

run_algo()