from openpyxl import load_workbook
import sys
import os
import django
from django.utils import timezone

if os.getenv('DJANGO_DEVELOPMENT') == 'true':
    print('DEV')
    path = os.path.join('C:\\Users\\bulmaj\\OneDrive - Cambridge\\Desktop\\Dev\\Nova')
    sys.path.append(path)
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings_dev'
elif os.getenv('DJANGO_PRODUCTION') == 'true':
    print('PROD')
    path = os.path.join('C:\\Dev\\Nova')
    sys.path.append(path)
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings_prod'
else:
    print('UAT')
    sys.path.append('C:/Dev/redepplan')
    os.environ['DJANGO_SETTINGS_MODULE'] = 'redepplan.settings'

django.setup()

from enquiries.models import TaskManager, RpaFailureAudit, ScriptApportionment, EnquiryComponentElements, CentreEnquiryRequests, EnquiryComponents, EnquiryComponentsHistory, TaskTypes, ScaledMarks
from django.contrib.auth.models import User

ec_list = [
'2011964',
'2011970',
'2011968',
'2011980',
'2011982',
'2012010',
'2012012',
'2012016',
'2012014',
'2012020',
'2012018',
'2012028',
'2012032',
'2012030',
'2012034',
'2012042',
'2012044',
'2012060',
'2012064',
'2012066',
'2012070',
'2012068',
'2012072',
'2012074',
'2012076',
'2012078',
'2012100',
'2012102',
'2012104',
'2012106',
'2012108',
'2012110',
'2012114',
'2012116',
'2012118',
'2012120',
'2012122',
'2012124',
'2012126',
'2012140',
'2012142',
'2012146',
'2012148',
'2012172',
'2012170',
'2012176',
'2012174',
'2012178',
'2012188',
'2012186',
'2012184',
'2012194',
'2012196',
'2012202',
'2012204',
'2012274',
'2012280',
'2012278',
'2012282',
'2012310',
'2012308',
'2012306',
'2012312',
'2012320',
'2012322',
'2012334',
'2012336',
'2012338',
'2012340',
'2012346',
'2012348',
'2012350',
'2012352',
'2012354',
'2012358',
'2012356',
'2012368',
'2012370',
'2012372',
'2012374',
'2012378',
'2012380',
'2012382',
'2012384',
'2012386',
'2012388',
'2012392',
'2012394',
'2012396',
'2012410',
'2012412',
'2012416',
'2012440',
'2012438',
'2012436',
'2012442',
'2012444',
'2012450',
'2012446',
'2012448',
'2012452',
'2012454',
'2012476',
'2012478',
'2012480',
'2012482',
'2012486',
'2012484',
'2012488',
'2012490',
'2012492',
'2012496',
'2012494',
'2012498',
'2012502',
'2012500',
'2012504',
'2012508',
'2012506',
'2012510',
'2012512',
'2012514',
'2012516',
'2012518',
'2012520',
'2012522',
'2012526',
'2012524',
'2012530',
'2012528',
'2012532',
'2012534',
'2012536',
'2012538',
'2012540',
'2012542',
'2012544',
'2012552',
'2012550',
'2012556',
'2012558',
'2012564',
'2012566',
'2012568',
'2012570',
'2012572',
'2012576',
'2012574',
'2012578',
'2012582',
'2012580',
'2012584',
'2012586',
'2012598',
'2012602',
'2012600',
'2012608',
'2012610',
'2012612',
'2012614',
'2012616',
'2012618',
'2012622',
'2012620',
'2012624',
'2012626',
'2012628',
'2012630',
'2012632',
'2012636',
'2012634',
'2012638',
'2012640',
'2012642',
'2012644',
'2012646',
'2012650',
'2012648',
'2012652',
'2012654',
'2012656',
'2012658',
'2012660',
'2012662',
'2012666',
'2012668',
'2012678',
'2012680',
'2012682',
'2012684',
'2012686',
'2012688',
'2012690',
'2012692',
'2012694',
'2012696',
'2012698',
'2012702',
'2012700',
'2012706',
'2012708',
'2012710',
'2012712',
'2012714',
'2012718',
'2012716',
'2012724',
'2012726',
'2012728',
'2012732',
'2012730',
'2012734',
'2012738',
'2012736',
'2012740',
'2012742',
'2012746',
'2012748',
'2012744',
'2012752',
'2012750',
'2012756',
'2012754',
'2012758',
'2012760',
'2012766',
'2012768',
'2012778',
'2012782',
'2012784',
'2012788',
'2012790',
'2012792',
'2012796',
'2012794',
'2012798',
'2012800',
'2012804',
'2012802',
'2012806',
'2012808',
'2012810',
'2012816',
'2012826',
'2012838',
'2012836',
'2012844',
'2012846',
'2012852',
'2012870',
'2012878',
'2012876',
'2012880',
'2012884',
'2012888',
'2012886',
'2012894',
'2012898',
'2012896',
'2012902',
'2012900',
'2012904',
'2012906',
'2012910',
'2012908',
'2012912',
'2012914',
'2012916',
'2012918',
'2012922',
'2012924',
'2012920',
'2012926',
'2012928',
'2012932',
'2012930',
'2012934',
'2012940',
'2012938',
'2012948',
'2012946',
'2012956',
'2012954',
'2012952',
'2012958',
'2012962',
'2012964',
'2012968',
'2012966',
'2012970',
'2012974',
'2012972',
'2012980',
'2012978',
'2012976',
'2012982',
'2012984',
'2012986',
'2012988',
'2012990',
'2012992',
'2013000',
'2013014',
'2013012',
'2013016',
'2013020',
'2013022',
'2013026',
'2013032',
'2013034',
'2013038',
'2013040',
'2013042',
'2013054',
'2013096',
'2013098',
'2013100',
'2013112',
'2013124',
'2013122',
'2013130',
'2013132',
'2013136',
'2013140',
'2013142',
'2013144',
'2013146',
'2013148',
'2013150',
'2013152',
'2013158',
'2013156',
'2013160',
'2013164',
'2013162',
'2013166',
'2013168',
'2013170',
'2013172',
'2013174',
'2013178',
'2013180',
'2013182',
'2013184',
'2013186',
'2013188',
'2013190',
'2013192',
'2013194',
'2013196',
'2013200',
'2013202',
'2013204',
'2013206',
'2013208',
'2013210',
'2013212',
'2013214',
'2013216',
'2013218',
'2013228',
'2013226',
'2013224',
'2013242',
'2013240',
'2013244',
'2013250',
'2013252',
'2013254',
'2013268',
'2013270',
'2013272',
'2013274',
'2013276',
'2013278',
'2013280',
'2013282',
'2013284',
'2013288',
'2013286',
'2013290',
'2013294',
'2013292',
'2013300',
'2013296',
'2013298',
'2013302',
'2013304',
'2013306',
'2013308',
'2013312',
'2013310',
'2013314',
'2013316',
'2013318',
'2013320',
'2013322',
'2013324',
'2013328',
'2013330',
'2013332',
'2013336',
'2013338',
'2013340',
'2013342',
'2013348',
'2013350',
'2013352',
'2013354',
'2013356',
'2013358',
'2013360',
'2013362',
'2013366',
'2013374',
'2013376',
'2013378',
'2013380',
'2013382',
'2013384',
'2013388',
'2013386',
'2013390',
'2013396',
'2013398',
'2013400',
'2013402',
'2013404',
'2013408',
'2013406',
'2013410',
'2013420',
'2013422',
'2013424',
'2013426',
'2013428',
'2013430',
'2013452',
'2013454',
'2013476',
'2013478',
'2013480',
'2013482',
'2013496',
'2013514',
'2013540',
'2013542',
'2013544',
'2013546',
'2013548',
'2013550',
'2013556',
'2013554',
'2013558',
'2013560',
'2013570',
'2013572',
'2013568',
'2013574',
'2013578',
'2013576',
'2013582',
'2013580',
'2013584',
'2013586',
'2013596',
'2013598',
'2013600',
'2013604',
'2013608',
'2013606',
'2013610',
'2013614',
'2013618',
'2013624',
'2013626',
'2013628',
'2013632',
'2013634',
'2013638',
'2013640',
'2013644',
'2013642',
'2013646',
'2013658',
'2013656',
'2013664',
'2013660',
'2013662',
'2013666',
'2013668',
'2013676',
'2013672',
'2013680',
'2013678',
'2013684',
'2013686',
'2013690',
'2013688',
'2013692',
'2013694',
'2013696',
'2013700',
'2013698',
'2013702',
'2013704',
'2013708',
'2013706',
'2013712',
'2013714',
'2013716',
'2013720',
'2013718',
'2013724',
'2013722',
'2013726',
'2013728',
'2013732',
'2013730',
'2013736',
'2013734',
'2013738',
'2013740',
'2013742',
'2013746',
'2013744',
'2013750',
'2013748',
'2013760',
'2013762',
'2013764',
'2013766',
'2013770',
'2013768',
'2013772',
'2013782',
'2013780',
'2013786',
'2013788',
'2013790',
'2013792',
'2013796',
'2013800',
'2013802',
'2013804',
'2013806',
'2013808',
'2013812',
'2013810',
'2013816',
'2013818',
'2013822',
'2013820',
'2013826',
'2013832',
'2013834',
'2013838',
'2013836',
'2013842',
'2013840',
'2013848',
'2013850',
'2013854',
'2013852',
'2013858',
'2013860',
'2013870',
'2013868',
'2013872',
'2013876',
'2013880',
'2013878',
'2013886',
'2013884',
'2013906',
'2013908',
'2013910',
'2013912',
'2013914',
'2013916',
'2013918',
'2013926',
'2013924',
'2013930',
'2013928',
'2013934',
'2013932',
'2013936',
'2013938',
'2013940',
'2013942',
'2013946',
'2013944',
'2013948',
'2013950',
'2013954',
'2013952',
'2013956',
'2013958',
'2013960',
'2013962',
'2013976',
'2013972',
'2014004',
'2014008',
'2014012',
'2014016',
'2014014',
'2014020',
'2014020',
'2014022',
'2014034',
'2014036',
'2014040',
'2014046',
'2014050',
'2014052',
'2014054',
'2014064',
'2014068',
'2014066',
'2014070',
'2014072',
'2014076',
'2014080',
'2014078',
'2014084',
'2014082',
'2014088',
'2014086',
'2014094',
'2014092',
'2014098',
'2014102',
'2014100',
'2014104',
'2014106',
'2014108',
'2014112',
'2014116',
'2014114',
'2014124',
'2014126',
'2014128',
'2014130',
'2014132',
'2014134',
'2014136',
'2014138',
'2014140',
'2014144',
'2014148',
'2014150',
'2014152',
'2014154',
'2014156',
'2014158',
'2014160',
'2014170',
'2014172',
'2014174',
'2014176',
'2014178',
'2014180',
'2014184',
'2014182',
'2014190',
'2014192',
'2014196',
'2014198',
'2014202',
'2014200',
'2014204',
'2014206',
'2014208',
'2014210',
'2014212',
'2014214',
'2014220',
'2014218',
'2014224',
'2014226',
'2014222',
'2014230',
'2014228',
'2014232',
'2014234',
'2014236',
'2014238',
'2014242',
'2014240',
'2014244',
'2014246',
'2014248',
'2014250',
'2014254',
'2014252',
'2014258',
'2014256',
'2014262',
'2014260',
'2014264',
'2014266',
'2014268',
'2014270',
'2014272',
'2014274',
'2014278',
'2014276',
'2014282',
'2014280',
'2014284',
'2014286',
'2014290',
'2014288',
'2014294',
'2014292',
'2014298',
'2014296',
'2014300',
'2014302',
'2014304',
'2014306',
'2014308',
'2014310',
'2014314',
'2014312',
'2014316',
'2014318',
'2014322',
'2014320',
'2014326',
'2014324',
'2014328',
'2014330',
'2014332',
'2014334',
'2014338',
'2014336',
'2014340',
'2014342',
'2014346',
'2014344',
'2014350',
'2014348',
'2014352',
'2014354',
'2014360',
'2014356',
'2014364',
'2014362',
'2014368',
'2014370',
'2014374',
'2014376',
'2014380',
'2014386',
'2014388',
'2014390',
'2014392',
'2014400',
'2014398',
'2014396',
'2014406',
'2014408',
'2014410',
'2014414',
'2014412',
'2014420',
'2014418',
'2014424',
'2014422',
'2014426',
'2014428',
'2014434',
'2014432',
'2014440',
'2014438',
'2014442',
'2014444',
'2014448',
'2014450',
'2014452',
'2014454',
'2014456',
'2014458',
'2014460',
'2014462',
'2014464',
'2014466',
'2014470',
'2014470',
'2014468',
'2014474',
'2014472',
'2014478',
'2014480',
'2014484',
'2014482',
'2014486',
'2014492',
'2014494',
'2014498',
'2014496',
'2014502',
'2014500',
'2014506',
'2014504',
'2014510',
'2014528',
'2014536',
'2014538',
'2014540',
'2014552',
'2014550',
'2014560',
'2014558',
'2014564',
'2014562',
'2014566',
'2014568',
'2014570',
'2014572',
'2014574',
'2014576',
'2014580',
'2014578',
'2014582',
'2014584',
'2014586',
'2014588',
'2014590',
'2014594',
'2014592',
'2014596',
'2014606',
'2014602',
'2014608',
'2014626',
'2014628',
'2014630',
'2014632',
'2014636',
'2014634',
'2014640',
'2014638',
'2014644',
'2014642',
'2014646',
'2014648',
'2014650',
'2014652',
'2014654',
'2014656',
'2014664',
'2014666',
'2014670',
'2014672',
'2014676',
'2014678',
'2014682',
'2014680',
'2014686',
'2014684',
'2014690',
'2014688',
'2014692',
'2014698',
'2014696',
'2014708',
'2014710',
'2014712',
'2014714',
'2014716',
'2014718',
'2014724',
'2014722',
'2014726',
'2014728',
'2014736',
'2014734',
'2014738',
'2014740',
'2014742',
'2014754',
'2014750',
'2014756',
'2014758',
'2014762',
'2014760',
'2014774',
'2014772',
'2014780',
'2014778',
'2014782',
'2014784',
'2014788',
'2014790',
'2014792',
'2014794',
'2014796',
'2014798',
'2014820',
'2014826',
'2014830',
'2014838',
'2014840',
'2014846',
'2014842',
'2014844',
'2014848',
'2014852',
'2014850',
'2014860',
'2014858',
'2014868',
'2014866',
'2014870',
'2014874',
'2014872',
'2014876',
'2014880',
'2014878',
'2014884',
'2014888',
'2014890',
'2014892',
'2014894',
'2014896',
'2014914',
'2014916',
'2014912',
'2014920',
'2014918',
'2014924',
'2014922',
'2014926',
'2014928',
'2014940',
'2014938',
'2014944',
'2014942',
'2014946',
'2014948',
'2014952',
'2014950',
'2014956',
'2014954',
'2014960',
'2014962',
'2014964',
'2014966',
'2014968',
'2014976',
'2014996',
'2014994',
'2015000',
'2014998',
'2015010',
'2015008',
'2015020',
'2015018',
'2015022',
'2015024',
'2015032',
'2015034',
'2015036',
'2015038',
'2015044',
'2015042',
'2015048',
'2015046',
'2015056',
'2015058',
'2015066',
'2015062',
'2015072',
'2015070',
'2015074',
'2015076',
'2015082',
'2015086',
'2015088',
'2015090',
'2015094',
'2015092',
'2015098',
'2015096',
'2015108',
'2015106',
'2015112',
'2015114',
'2015120',
'2015118',
'2015122',
'2015130',
'2015134',
'2015138',
'2015136',
'2015148',

]

def run_algo():
    for app_task in TaskManager.objects.filter(task_id='BOTAPP', ec_sid__in = ec_list,task_completion_date = None):
        enquiry_id = TaskManager.objects.filter(ec_sid=app_task.ec_sid.ec_sid,task_id='BOTAPP').first().enquiry_id.enquiry_id
        script_id = TaskManager.objects.filter(ec_sid=app_task.ec_sid.ec_sid,task_id='BOTAPP').first().ec_sid.ec_sid
        print(enquiry_id)
        #create a new task for the next step (BOTMAF)
        if not TaskManager.objects.filter(ec_sid=script_id, task_id='BOTAPF',task_completion_date = None).exists():
            print("Switched")
            this_task = TaskManager.objects.create(
                enquiry_id = CentreEnquiryRequests.objects.get(enquiry_id=enquiry_id),
                ec_sid = EnquiryComponents.objects.get(ec_sid=app_task.ec_sid.ec_sid),
                task_id = TaskTypes.objects.get(task_id = 'BOTAPF'),
                task_assigned_to = None,
                task_assigned_date = None,
                task_completion_date = None
            )
            this_task.refresh_from_db()
            RpaFailureAudit.objects.create(
                rpa_task_key = TaskManager.objects.get(pk=this_task.pk),
                failure_reason = "Priority Manual Keying"
            )
            #complete the task
            TaskManager.objects.filter(ec_sid=app_task.ec_sid.ec_sid,task_id='BOTAPP').update(task_completion_date=timezone.now())
        else:
            print("Not Switched")


run_algo()